"""
Google AI Search MCP Server

æä¾› Google AI æœç´¢åŠŸèƒ½çš„ MCP æœåŠ¡å™¨ã€‚
"""

import asyncio
import logging
import time
from concurrent.futures import ThreadPoolExecutor
from typing import Any, Optional

# åº”ç”¨ nest_asyncio å…è®¸åµŒå¥—äº‹ä»¶å¾ªç¯ï¼ˆè§£å†³ Playwright sync API ä¸ asyncio å†²çªï¼‰
import nest_asyncio
nest_asyncio.apply()

from mcp.server import Server
from mcp.server.stdio import stdio_server
from mcp.types import Tool, TextContent

from .searcher import GoogleAISearcher, SearchResult, logger as searcher_logger

# ä½¿ç”¨ä¸ searcher ç›¸åŒçš„æ—¥å¿—å™¨
logger = logging.getLogger("google_ai_search")
logger.info("MCP Server æ¨¡å—åŠ è½½")


# åˆ›å»º MCP Server
server = Server("huge-ai-search")

# åˆ›å»ºæœç´¢å™¨å®ä¾‹ï¼ˆä½¿ç”¨æŒä¹…åŒ–ç”¨æˆ·æ•°æ®ç›®å½•ï¼‰
# headless=True ä½¿ç”¨ Edge é™é»˜æ¨¡å¼ï¼ˆEdge å¯¹ Cookie æ”¯æŒæ›´å¥½ï¼‰
searcher = GoogleAISearcher(headless=True, use_user_data=True, timeout=60)

# çº¿ç¨‹æ± ç”¨äºè¿è¡ŒåŒæ­¥çš„ Playwright ä»£ç 
# æœ€ä½³å®è·µï¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–å…¨å±€ Executorï¼Œä¸è¦æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»º
_executor = ThreadPoolExecutor(max_workers=1)

# å¹¶å‘æ§åˆ¶ï¼šä½¿ç”¨ Semaphore é™åˆ¶åŒæ—¶è¿›è¡Œçš„æœç´¢æ•°é‡ï¼Œé˜²æ­¢çº¿ç¨‹æ± è€—å°½
# æœ€ä½³å®è·µï¼šé™åˆ¶å¹¶å‘æäº¤æ•°é‡ï¼Œé¿å…ä»»åŠ¡é˜Ÿåˆ—æ— é™å †ç§¯
_search_semaphore: Optional[asyncio.Semaphore] = None
_MAX_CONCURRENT_SEARCHES = 2  # æœ€å¤§å¹¶å‘æœç´¢æ•°

# æœç´¢è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰- é˜²æ­¢ä»»åŠ¡æ°¸ä¹…é˜»å¡
_SEARCH_TIMEOUT_SECONDS = 120


def _get_semaphore() -> asyncio.Semaphore:
    """è·å–æˆ–åˆ›å»º Semaphoreï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„äº‹ä»¶å¾ªç¯ä¸­åˆ›å»ºï¼‰"""
    global _search_semaphore
    if _search_semaphore is None:
        _search_semaphore = asyncio.Semaphore(_MAX_CONCURRENT_SEARCHES)
    return _search_semaphore


# ç™»å½•è¶…æ—¶å†·å´æœºåˆ¶
# æ³¨æ„ï¼šMCP æœåŠ¡å™¨æ— æ³•æ£€æµ‹"å¯¹è¯ç»“æŸ"äº‹ä»¶ï¼Œå› ä¸ºå®ƒæ˜¯æŒä¹…è¿è¡Œçš„è¿›ç¨‹
# ä½¿ç”¨æ—¶é—´æˆ³æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•ï¼Œè®© AI åŠ©æ‰‹å†³å®šæ˜¯å¦åœ¨æ–°å¯¹è¯ä¸­é‡è¯•
_login_timeout_timestamp: Optional[float] = None  # ä¸Šæ¬¡ç™»å½•è¶…æ—¶çš„æ—¶é—´æˆ³
_LOGIN_COOLDOWN_SECONDS = 300  # å†·å´æ—¶é—´ï¼š5åˆ†é’Ÿï¼ˆç”¨æˆ·å¯èƒ½å›æ¥äº†ï¼‰


# å·¥å…·æè¿°æ–‡æœ¬
_TOOL_DESCRIPTION = (
    "ä½¿ç”¨ AI æ¨¡å¼æœç´¢ï¼Œè·å– AI æ€»ç»“çš„æœç´¢ç»“æœã€‚\n\n"
    "ğŸŒŸğŸŒŸğŸŒŸ **å…¨èƒ½é€šç”¨æœç´¢å·¥å…· - æœ‰ä»»ä½•ä¸ç¡®å®šçš„äº‹æƒ…éƒ½å¯ä»¥æœï¼** ğŸŒŸğŸŒŸğŸŒŸ\n\n"
    "è¿™æ˜¯ä½ çš„**é¦–é€‰æœç´¢å·¥å…·**ï¼Œé€‚ç”¨äºå‡ ä¹æ‰€æœ‰éœ€è¦è·å–å¤–éƒ¨ä¿¡æ¯çš„åœºæ™¯ã€‚\n"
    "ä¸è¦çŠ¹è±«ï¼Œä¸è¦ç­‰å¾…æ˜ç¡®æŒ‡ä»¤ â€”â€” é‡åˆ°ä»»ä½•ä¸ç¡®å®šçš„é—®é¢˜ï¼Œå…ˆæœä¸€ä¸‹ç¡®è®¤ï¼\n\n"
    "ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼šç”¨è‡ªç„¶è¯­è¨€æé—®ï¼Œä¸è¦ç”¨å…³é”®è¯å †ç Œï¼\n"
    "è¿™æ˜¯å¯¹è¯å¼ AI æœç´¢ï¼Œåƒå’Œäººè¯´è¯ä¸€æ ·æé—®æ•ˆæœæœ€å¥½ã€‚\n\n"
    "ğŸš¨ğŸš¨ğŸš¨ **æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼šBug/é—®é¢˜æ’æŸ¥å¿…é¡»å…ˆæœç´¢ï¼** ğŸš¨ğŸš¨ğŸš¨\n\n"
    "å½“ç”¨æˆ·æŠ¥å‘Š bugã€é—®é¢˜ã€é”™è¯¯ã€å¼‚å¸¸è¡Œä¸ºæ—¶ï¼š\n"
    "1. **ç¬¬ä¸€æ­¥**ï¼šä½¿ç”¨æ­¤å·¥å…·æœç´¢é—®é¢˜çš„å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ\n"
    "2. **ç¬¬äºŒæ­¥**ï¼šé˜…è¯»æœç´¢ç»“æœï¼Œäº†è§£ä¸šç•Œå·²çŸ¥çš„è§£å†³æ–¹æ¡ˆ\n"
    "3. **ç¬¬ä¸‰æ­¥**ï¼šå†å¼€å§‹è¯»ä»£ç ã€åŠ æ—¥å¿—ã€ä¿®æ”¹ä»£ç \n\n"
    "**ç¦æ­¢è¡Œä¸º**ï¼šç›´æ¥å¼€å§‹è¯»ä»£ç è°ƒè¯•ï¼Œè·³è¿‡æœç´¢æ­¥éª¤ï¼\n\n"
    "ğŸ’¡ **å…³é”®æ´å¯Ÿ**ï¼šå¾ˆå¤šçœ‹èµ·æ¥æ˜¯ã€Œé¡¹ç›®ç‰¹å®šçš„ bugã€ï¼Œå®é™…ä¸Šæ˜¯ã€Œé€šç”¨çš„æŠ€æœ¯é—®é¢˜ã€ã€‚\n"
    "ä¾‹å¦‚ï¼šã€Œè¿½é—®æ—¶è¿”å›é‡å¤å†…å®¹ã€â†’ å®é™…æ˜¯ã€Œç½‘é¡µçˆ¬è™«å¤šè½®å¯¹è¯å¦‚ä½•åªæå–æ–°å¢å†…å®¹ã€çš„é€šç”¨é—®é¢˜ã€‚\n"
    "æœç´¢åå¾€å¾€èƒ½æ‰¾åˆ°ä¸šç•Œæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”è‡ªå·±ä»é›¶æ€è€ƒæ›´é«˜æ•ˆã€‚\n\n"
    "ğŸ”¥ **å¼ºçƒˆå»ºè®®ä¸»åŠ¨ä½¿ç”¨çš„åœºæ™¯**:\n"
    "- **ç”¨æˆ·æŠ¥å‘Š bug/é—®é¢˜/é”™è¯¯** â†’ å¿…é¡»å…ˆæœç´¢å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼\n"
    "- ä»»ä½•ä½ ä¸100%ç¡®å®šçš„æŠ€æœ¯é—®é¢˜ â†’ æœä¸€ä¸‹ç¡®è®¤\n"
    "- ä»»ä½•å¯èƒ½æœ‰æ›´æ–°çš„ä¿¡æ¯ â†’ æœä¸€ä¸‹è·å–æœ€æ–°\n"
    "- ä»»ä½•æœ€ä½³å®è·µ/æ¨èåšæ³• â†’ æœä¸€ä¸‹çœ‹ä¸šç•Œæ ‡å‡†\n"
    "- ä»»ä½•è®¾è®¡å†³ç­– â†’ æœä¸€ä¸‹å‚è€ƒè¡Œä¸šç»éªŒ\n"
    "- ä»»ä½•é”™è¯¯æ’æŸ¥ â†’ æœä¸€ä¸‹çœ‹è§£å†³æ–¹æ¡ˆ\n"
    "- å†™ä»£ç å‰ä¸ç¡®å®šçš„ API ç”¨æ³• â†’ æœä¸€ä¸‹ç¡®è®¤\n"
    "- åšæŠ€æœ¯é€‰å‹ â†’ æœä¸€ä¸‹å¯¹æ¯”å„æ–¹æ¡ˆ\n"
    "- **å®ç°æŸä¸ªåŠŸèƒ½å‰** â†’ æœä¸€ä¸‹çœ‹æœ‰æ²¡æœ‰ç°æˆçš„æœ€ä½³å®è·µ\n\n"
    "ğŸš¨ **å¿…é¡»ç«‹å³æœç´¢çš„åœºæ™¯**ï¼ˆä¸è¦è·³è¿‡ï¼ï¼‰:\n"
    "| åœºæ™¯ | æœç´¢ç¤ºä¾‹ |\n"
    "| ç”¨æˆ·æŠ¥å‘Š bug/é—®é¢˜ | ã€ŒPySide6 çª—å£éšè—åæ— æ³•å†æ¬¡æ˜¾ç¤ºï¼Œæœ‰å“ªäº›å¸¸è§åŸå› ï¼Ÿã€ |\n"
    "| çª—å£/UI è¡Œä¸ºå¼‚å¸¸ | ã€ŒQt QMainWindow hide å show ä¸å·¥ä½œï¼Œå¦‚ä½•è§£å†³ï¼Ÿã€ |\n"
    "| æ•°æ®é‡å¤/ä¸¢å¤±é—®é¢˜ | ã€Œç½‘é¡µçˆ¬è™«å¤šè½®å¯¹è¯æ—¶ï¼Œå¦‚ä½•åªæå–æ–°å¢å†…å®¹ï¼Ÿã€ |\n"
    "| ä¿¡å·/æ§½ä¸å·¥ä½œ | ã€ŒPySide6 ä¿¡å·åœ¨çª—å£éšè—åä¸è§¦å‘ï¼Œæ˜¯ä»€ä¹ˆåŸå› ï¼Ÿã€ |\n"
    "| å†…å­˜/èµ„æºé—®é¢˜ | ã€ŒPySide6 çª—å£è¢«åƒåœ¾å›æ”¶å¯¼è‡´æ— æ³•æ˜¾ç¤ºï¼Œå¦‚ä½•é¿å…ï¼Ÿã€ |\n"
    "| ä»»ä½•ã€Œä¸å·¥ä½œã€çš„é—®é¢˜ | å…ˆæœç´¢å¸¸è§åŸå› ï¼Œå†è¯»ä»£ç  |\n\n"
    "è§¦å‘å…³é”®è¯: æœç´¢ã€searchã€æŸ¥è¯¢ã€æŸ¥æ‰¾ã€æœä¸€ä¸‹ã€å¸®æˆ‘æœã€ç½‘ä¸ŠæŸ¥ã€"
    "æœ€æ–°ä¿¡æ¯ã€å®æ—¶ä¿¡æ¯ã€æœ€ä½³å®è·µã€best practiceã€æ¨èåšæ³•ã€æ€ä¹ˆåšæ¯”è¾ƒå¥½ã€ä¸šç•Œæ ‡å‡†ã€"
    "è¡Œä¸šè§„èŒƒã€UIè®¾è®¡ã€UXè®¾è®¡ã€ç”¨æˆ·ä½“éªŒã€ç•Œé¢è®¾è®¡ã€äº¤äº’è®¾è®¡ã€è®¾è®¡è§„èŒƒã€è®¾è®¡ç³»ç»Ÿã€"
    "design systemã€design patternã€ç»„ä»¶è®¾è®¡ã€å¸ƒå±€è®¾è®¡ã€å“åº”å¼è®¾è®¡ã€æ— éšœç¢è®¾è®¡ã€accessibilityã€"
    "bugã€é—®é¢˜ã€é”™è¯¯ã€ä¸å·¥ä½œã€å¤±è´¥ã€å¼‚å¸¸ã€æ— æ³•ã€æ‰“ä¸å¼€ã€æ˜¾ç¤ºä¸å‡ºæ¥ã€é‡å¤ã€ä¸¢å¤±\n\n"
    "é€‚ç”¨åœºæ™¯ï¼ˆå‡ ä¹æ‰€æœ‰éœ€è¦å¤–éƒ¨ä¿¡æ¯çš„æƒ…å†µï¼‰:\n"
    "- **Bug æ’æŸ¥å’Œé—®é¢˜è¯Šæ–­**ï¼ˆæœ€é‡è¦ï¼å…ˆæœç´¢å†è¯»ä»£ç ï¼‰\n"
    "- éœ€è¦è·å–æœ€æ–°ã€å®æ—¶çš„ä¿¡æ¯ï¼ˆå¦‚æ–°é—»ã€æŠ€æœ¯åŠ¨æ€ã€äº§å“å‘å¸ƒï¼‰\n"
    "- éœ€è¦ AI æ€»ç»“çš„ç»¼åˆç­”æ¡ˆè€ŒéåŸå§‹ç½‘é¡µåˆ—è¡¨\n"
    "- æŸ¥è¯¢æŠ€æœ¯é—®é¢˜ã€ç¼–ç¨‹é—®é¢˜ã€API ç”¨æ³•\n"
    "- äº†è§£æŸä¸ªè¯é¢˜çš„æ¦‚è¿°å’Œè¦ç‚¹\n"
    "- éœ€è¦å¸¦æ¥æºå¼•ç”¨çš„å¯é ä¿¡æ¯\n"
    "- æŸ¥è¯¢æœ€ä½³å®è·µã€æ¨èåšæ³•ã€è¡Œä¸šæ ‡å‡†\n"
    "- UI/UX è®¾è®¡æœ€ä½³å®è·µå’Œè®¾è®¡è§„èŒƒ\n"
    "- ç»„ä»¶è®¾è®¡æ¨¡å¼ã€äº¤äº’è®¾è®¡æŒ‡å—\n"
    "- è®¾è®¡ç³»ç»Ÿå‚è€ƒï¼ˆMaterial Designã€Ant Design ç­‰ï¼‰\n"
    "- å“åº”å¼å¸ƒå±€å’Œæ— éšœç¢è®¾è®¡æ ‡å‡†\n"
    "- é”™è¯¯ä¿¡æ¯æ’æŸ¥å’Œè§£å†³æ–¹æ¡ˆ\n"
    "- æŠ€æœ¯é€‰å‹å’Œæ–¹æ¡ˆå¯¹æ¯”\n"
    "- éªŒè¯è‡ªå·±çš„ç†è§£æ˜¯å¦æ­£ç¡®\n\n"
    "âš ï¸ æœç´¢ç­–ç•¥æŒ‡å—ï¼ˆé‡è¦ï¼‰:\n"
    "**å®å¯å¤šæœä¹Ÿä¸è¦å‡­è®°å¿†çŒœæµ‹ï¼** æœç´¢æˆæœ¬å¾ˆä½ï¼Œä½†é”™è¯¯çš„ä¿¡æ¯ä»£ä»·å¾ˆé«˜ã€‚\n\n"
    "âœ… åº”è¯¥æœç´¢ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰:\n"
    "- **ç”¨æˆ·æŠ¥å‘Šçš„ä»»ä½• bug/é—®é¢˜**: å…ˆæœç´¢å¸¸è§åŸå› ï¼Œå†è¯»ä»£ç ï¼\n"
    "- å®æ—¶/æ—¶æ•ˆæ€§ä¿¡æ¯: æœ€æ–°ç‰ˆæœ¬å·ã€è¿‘æœŸå‘å¸ƒã€å½“å‰ä»·æ ¼ã€æœ€æ–°åŠ¨æ€\n"
    "- å…·ä½“äº§å“/æœåŠ¡ç»†èŠ‚: ç‰¹å®š API çš„æœ€æ–°ç”¨æ³•ã€æŸäº§å“çš„å…·ä½“é…ç½®å‚æ•°\n"
    "- è¡Œä¸šæœ€æ–°å®è·µ: 2024/2025 å¹´çš„æœ€ä½³å®è·µã€æ–°å…´æŠ€æœ¯è¶‹åŠ¿\n"
    "- äº‰è®®æ€§/æ— å®šè®ºé—®é¢˜: ä¸åŒæ–¹æ¡ˆçš„ä¼˜åŠ£å¯¹æ¯”ã€ç¤¾åŒºè®¨è®ºçƒ­ç‚¹\n"
    "- å°ä¼—/å†·é—¨çŸ¥è¯†: ç‰¹å®šæ¡†æ¶çš„è¾¹ç¼˜ç”¨æ³•ã€ç½•è§é”™è¯¯çš„è§£å†³æ–¹æ¡ˆ\n"
    "- **ä»»ä½•ä½ ä¸ç¡®å®šçš„äº‹æƒ…**: ä¸å…¶çŒœæµ‹ï¼Œä¸å¦‚èŠ±å‡ ç§’æœç´¢ç¡®è®¤\n\n"
    "âŒ å¯ä»¥ä¸æœç´¢ï¼ˆä½†æœäº†ä¹Ÿæ²¡åå¤„ï¼‰:\n"
    "- åŸºç¡€æ¦‚å¿µ: ä»€ä¹ˆæ˜¯ REST APIã€JavaScript é—­åŒ…åŸç†\n"
    "- ç¨³å®šçš„è¯­æ³•/ç”¨æ³•: Python åˆ—è¡¨æ“ä½œã€SQL åŸºæœ¬è¯­æ³•\n"
    "- é€šç”¨è®¾è®¡æ¨¡å¼: å•ä¾‹æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼çš„åŸºæœ¬å®ç°\n"
    "- AI è®­ç»ƒæ•°æ®å†…çš„çŸ¥è¯†: ç»å…¸ç®—æ³•ã€æˆç†Ÿæ¡†æ¶çš„å¸¸è§„ç”¨æ³•\n\n"
    "ğŸ’¡ æé—®æŠ€å·§ï¼ˆä»æœç´¢æ€ç»´è½¬å˜ä¸ºæŒ‡ä»¤æ€ç»´ï¼‰:\n"
    "- ç”¨å®Œæ•´çš„è‡ªç„¶è¯­è¨€å¥å­æé—®ï¼Œä¸è¦å †ç Œå…³é”®è¯\n"
    "- è¯´æ˜å…·ä½“åœºæ™¯å’Œéœ€æ±‚ï¼Œè®© AI ç†è§£ä½ çš„æ„å›¾\n"
    "- å¯ä»¥è¦æ±‚ç‰¹å®šè¾“å‡ºæ ¼å¼ï¼ˆå¦‚ã€Œè¯·åˆ—å‡ºæ­¥éª¤ã€ã€ã€Œè¯·å¯¹æ¯”ä¼˜ç¼ºç‚¹ã€ï¼‰\n"
    "- å¤æ‚é—®é¢˜åŠ ä¸Šã€Œè¯·ä¸€æ­¥æ­¥åˆ†æã€å¼•å¯¼ AI å±•ç¤ºæ€è€ƒè¿‡ç¨‹\n"
    "- åŠ ä¸Šæ—¶é—´é™å®šè¯ï¼ˆå¦‚ã€Œ2025å¹´ã€ã€ã€Œæœ€æ–°ã€ï¼‰è·å–æ—¶æ•ˆæ€§ä¿¡æ¯\n\n"
    "ç‰¹ç‚¹: ä½¿ç”¨ Patchright é˜²æ£€æµ‹æŠ€æœ¯ï¼Œæ”¯æŒä¸­è‹±æ–‡æœç´¢ï¼Œè¿”å› AI æ€»ç»“ + æ¥æºé“¾æ¥ï¼Œæ”¯æŒå¤šè½®å¯¹è¯è¿½é—®ã€‚\n\n"
    "ğŸ”„ **å¤šè½®å¯¹è¯åŠŸèƒ½ï¼ˆé‡è¦ï¼ä½ éœ€è¦è‡ªä¸»åˆ¤æ–­ï¼‰**:\n\n"
    "ä½ éœ€è¦æ ¹æ®ä¸Šä¸‹æ–‡**è‡ªä¸»å†³å®š**æ˜¯è¿½é—®è¿˜æ˜¯æ–°å¼€å¯¹è¯ï¼š\n\n"
    "âœ… **ä½¿ç”¨ `follow_up: true`ï¼ˆè¿½é—®ï¼‰**:\n"
    "- å¯¹ä¸Šä¸€ä¸ªæœç´¢ç»“æœéœ€è¦æ›´å¤šç»†èŠ‚æˆ–è§£é‡Š\n"
    "- æƒ³ä»ä¸åŒè§’åº¦æ·±å…¥æ¢è®¨**åŒä¸€è¯é¢˜**\n"
    "- ä¸Šä¸€ä¸ªå›ç­”ä¸å¤Ÿå®Œæ•´ï¼Œéœ€è¦è¡¥å……\n"
    "- ç”¨æˆ·è¯´ã€Œç»§ç»­ã€ã€Œè¯¦ç»†è¯´è¯´ã€ã€Œè¿˜æœ‰å‘¢ã€ç­‰è¿½é—®æ„å›¾\n"
    "- è¿ç»­ç›¸å…³é—®é¢˜ï¼ˆå¦‚ï¼šå…ˆé—® React hooksï¼Œå†é—® useEffect ç»†èŠ‚ï¼‰\n\n"
    "âŒ **ä½¿ç”¨ `follow_up: false`ï¼ˆæ–°å¯¹è¯ï¼‰**:\n"
    "- å®Œå…¨ä¸åŒçš„è¯é¢˜ï¼ˆå¦‚ï¼šä» React åˆ‡æ¢åˆ° Pythonï¼‰\n"
    "- ç”¨æˆ·å¼€å§‹äº†æ–°çš„ä»»åŠ¡æˆ–é—®é¢˜\n"
    "- éœ€è¦åˆ‡æ¢æœç´¢è¯­è¨€\n"
    "- è·ç¦»ä¸Šæ¬¡æœç´¢è¯é¢˜å·²ç»å˜äº†\n"
    "- ä¸ç¡®å®šæ—¶ï¼Œé»˜è®¤ false æ›´å®‰å…¨\n\n"
    "ğŸ’¡ **åˆ¤æ–­æŠ€å·§**ï¼šé—®è‡ªå·±ã€Œè¿™ä¸ªé—®é¢˜å’Œä¸Šä¸€ä¸ªæœç´¢æœ‰å…³è”å—ï¼Ÿã€æœ‰å…³è”ç”¨ trueï¼Œæ— å…³è”ç”¨ falseã€‚"
)

_QUERY_DESCRIPTION = (
    "å‘ Google AI æé—®çš„è‡ªç„¶è¯­è¨€é—®é¢˜ã€‚\n\n"
    "âš ï¸ é‡è¦ï¼šä½¿ç”¨å®Œæ•´çš„è‡ªç„¶è¯­è¨€å¥å­æé—®ï¼Œè€Œéå…³é”®è¯å †ç Œï¼\n\n"
    "âœ… æ­£ç¡®çš„æé—®æ–¹å¼ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰:\n"
    "- ã€ŒGitHub push å¤§æ–‡ä»¶å¤±è´¥æ€ä¹ˆè§£å†³ï¼Ÿæœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿã€\n"
    "- ã€Œ2025å¹´ React å’Œ Vue å“ªä¸ªæ›´é€‚åˆæ–°é¡¹ç›®ï¼Ÿå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿã€\n"
    "- ã€Œå¦‚ä½•åœ¨ Python ä¸­å®ç°å¼‚æ­¥å¹¶å‘ï¼Ÿè¯·ç»™å‡ºæœ€ä½³å®è·µå’Œä»£ç ç¤ºä¾‹ã€\n"
    "- ã€ŒNext.js 14 çš„ App Router å’Œ Pages Router æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿè¯¥æ€ä¹ˆé€‰æ‹©ï¼Ÿã€\n\n"
    "âŒ é”™è¯¯çš„æé—®æ–¹å¼ï¼ˆå…³é”®è¯å †ç Œï¼‰:\n"
    "- ã€ŒGitHub push å¤§æ–‡ä»¶å¤±è´¥ è§£å†³æ–¹æ¡ˆ 2025ã€\n"
    "- ã€ŒReact Vue å¯¹æ¯” 2025ã€\n"
    "- ã€ŒPython asyncio æœ€ä½³å®è·µã€\n"
    "- ã€ŒNext.js App Router Pages Router åŒºåˆ«ã€\n\n"
    "ğŸ’¡ æé—®æŠ€å·§:\n"
    "1. åƒå’Œäººå¯¹è¯ä¸€æ ·æé—®ï¼Œç”¨å®Œæ•´å¥å­\n"
    "2. è¯´æ˜ä½ çš„å…·ä½“åœºæ™¯å’Œéœ€æ±‚\n"
    "3. å¯ä»¥è¦æ±‚ç‰¹å®šæ ¼å¼ï¼ˆå¦‚ã€Œè¯·åˆ—å‡ºæ­¥éª¤ã€ã€ã€Œè¯·å¯¹æ¯”ä¼˜ç¼ºç‚¹ã€ï¼‰\n"
    "4. å¤æ‚é—®é¢˜å¯ä»¥è¦æ±‚ã€Œè¯·ä¸€æ­¥æ­¥åˆ†æã€"
)


@server.list_tools()
async def list_tools() -> list[Tool]:
    """åˆ—å‡ºå¯ç”¨çš„å·¥å…·"""
    return [
        Tool(
            name="huge_ai_search",
            description=_TOOL_DESCRIPTION,
            inputSchema={
                "type": "object",
                "properties": {
                    "query": {
                        "type": "string",
                        "description": _QUERY_DESCRIPTION
                    },
                    "language": {
                        "type": "string",
                        "description": "æœç´¢ç»“æœè¯­è¨€ã€‚zh-CN è¿”å›ä¸­æ–‡ç»“æœï¼Œen-US è¿”å›è‹±æ–‡ç»“æœã€‚æ ¹æ®æŸ¥è¯¢å†…å®¹è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„è¯­è¨€ã€‚",
                        "default": "zh-CN",
                        "enum": ["zh-CN", "en-US", "ja-JP", "ko-KR", "de-DE", "fr-FR"]
                    },
                    "follow_up": {
                        "type": "boolean",
                        "description": "**ä½ éœ€è¦è‡ªä¸»åˆ¤æ–­**ï¼šå½“å‰é—®é¢˜æ˜¯å¦ä¸ä¸Šä¸€æ¬¡æœç´¢ç›¸å…³ï¼Ÿç›¸å…³è¯é¢˜è®¾ trueï¼ˆè¿½é—®ï¼‰ï¼Œä¸ç›¸å…³æˆ–æ–°è¯é¢˜è®¾ falseï¼ˆæ–°å¯¹è¯ï¼‰ã€‚è¿½é—®æ—¶ä¿æŒä¸Šä¸‹æ–‡åªè¿”å›æ–°å¢å†…å®¹ã€‚ä¸ç¡®å®šæ—¶é»˜è®¤ falseã€‚",
                        "default": False
                    }
                },
                "required": ["query"]
            }
        )
    ]


@server.call_tool()
async def call_tool(name: str, arguments: dict[str, Any]) -> list[TextContent]:
    """æ‰§è¡Œå·¥å…·è°ƒç”¨"""
    global _login_timeout_timestamp
    
    logger.info(f"æ”¶åˆ°å·¥å…·è°ƒç”¨: name={name}, arguments={arguments}")
    
    if name != "huge_ai_search":
        logger.error(f"æœªçŸ¥å·¥å…·: {name}")
        raise ValueError(f"æœªçŸ¥å·¥å…·: {name}")
    
    query = arguments.get("query", "")
    language = arguments.get("language", "zh-CN")
    follow_up = arguments.get("follow_up", False)
    
    if not query:
        logger.warning("æœç´¢æŸ¥è¯¢ä¸ºç©º")
        return [TextContent(type="text", text="é”™è¯¯: è¯·æä¾›æœç´¢å…³é”®è¯")]
    
    # æ£€æŸ¥æ˜¯å¦åœ¨ç™»å½•è¶…æ—¶å†·å´æœŸå†…
    if _login_timeout_timestamp is not None:
        elapsed = time.time() - _login_timeout_timestamp
        if elapsed < _LOGIN_COOLDOWN_SECONDS:
            remaining = int(_LOGIN_COOLDOWN_SECONDS - elapsed)
            remaining_min = remaining // 60
            logger.info(f"å¤„äºå†·å´æœŸï¼Œå‰©ä½™ {remaining_min}åˆ†{remaining % 60}ç§’")
            return [TextContent(
                type="text", 
                text=f"â¸ï¸ Google AI æœç´¢æš‚æ—¶ä¸å¯ç”¨\n\n"
                     f"ä¸Šæ¬¡æœç´¢éœ€è¦ç”¨æˆ·ç™»å½•éªŒè¯ä½†è¶…æ—¶æœªå®Œæˆï¼ˆå¯èƒ½ç”¨æˆ·ä¸åœ¨ç”µè„‘å‰ï¼‰ã€‚\n"
                     f"å†·å´å‰©ä½™: {remaining_min} åˆ† {remaining % 60} ç§’\n\n"
                     f"**å»ºè®®**: å¦‚æœè¿™æ˜¯æ–°çš„å¯¹è¯ï¼Œç”¨æˆ·å¯èƒ½å·²ç»å›æ¥äº†ï¼Œå¯ä»¥å‘ŠçŸ¥ç”¨æˆ·æ‰‹åŠ¨è§¦å‘é‡è¯•ã€‚\n"
                     f"æˆ–è€…ä½¿ç”¨å…¶ä»–æœç´¢å·¥å…·ï¼ˆå¦‚ exa_web_searchï¼‰ä½œä¸ºæ›¿ä»£ã€‚"
            )]
        else:
            # å†·å´æœŸå·²è¿‡ï¼Œé‡ç½®çŠ¶æ€
            logger.info("å†·å´æœŸå·²è¿‡ï¼Œé‡ç½®çŠ¶æ€")
            _login_timeout_timestamp = None
    
    # ä½¿ç”¨ Semaphore é™åˆ¶å¹¶å‘æœç´¢æ•°é‡ï¼ˆæœ€ä½³å®è·µï¼šé˜²æ­¢çº¿ç¨‹æ± è€—å°½ï¼‰
    semaphore = _get_semaphore()
    
    # å°è¯•è·å–ä¿¡å·é‡ï¼Œå¦‚æœå·²æ»¡åˆ™ç­‰å¾…
    logger.info(f"ç­‰å¾…è·å–æœç´¢æ§½ä½ï¼ˆå½“å‰é™åˆ¶: {_MAX_CONCURRENT_SEARCHES}ï¼‰")
    
    try:
        async with semaphore:
            logger.info(f"è·å–åˆ°æœç´¢æ§½ä½ï¼Œå¼€å§‹æ‰§è¡Œæœç´¢: query='{query}', language={language}, follow_up={follow_up}")
            loop = asyncio.get_running_loop()
            
            # ä½¿ç”¨ asyncio.wait_for è®¾ç½®è¶…æ—¶ï¼ˆæœ€ä½³å®è·µï¼šé˜²æ­¢ä»»åŠ¡æ°¸ä¹…é˜»å¡ï¼‰
            try:
                if follow_up and searcher.has_active_session():
                    # è¿½é—®æ¨¡å¼ï¼šä¿æŒä¼šè¯ç»§ç»­å¯¹è¯
                    logger.info("ä½¿ç”¨è¿½é—®æ¨¡å¼ï¼ˆcontinue_conversationï¼‰")
                    result = await asyncio.wait_for(
                        loop.run_in_executor(_executor, searcher.continue_conversation, query),
                        timeout=_SEARCH_TIMEOUT_SECONDS
                    )
                else:
                    if follow_up:
                        logger.info("è¯·æ±‚è¿½é—®ä½†æ²¡æœ‰æ´»è·ƒä¼šè¯ï¼Œä½¿ç”¨æ–°æœç´¢")
                    # æ–°æœç´¢
                    logger.info("ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œæ–°æœç´¢")
                    result = await asyncio.wait_for(
                        loop.run_in_executor(_executor, searcher.search, query, language),
                        timeout=_SEARCH_TIMEOUT_SECONDS
                    )
            except asyncio.TimeoutError:
                logger.error(f"æœç´¢è¶…æ—¶ï¼ˆ{_SEARCH_TIMEOUT_SECONDS}ç§’ï¼‰")
                return [TextContent(type="text", text=f"æœç´¢è¶…æ—¶ï¼ˆ{_SEARCH_TIMEOUT_SECONDS}ç§’ï¼‰ï¼Œè¯·ç¨åé‡è¯•")]
                
    except Exception as e:
        logger.error(f"æœç´¢æ‰§è¡Œå¼‚å¸¸: {type(e).__name__}: {e}")
        return [TextContent(type="text", text=f"æœç´¢æ‰§è¡Œå¼‚å¸¸: {e}")]
    
    logger.info(f"æœç´¢ç»“æœ: success={result.success}, error={result.error if not result.success else 'N/A'}")
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯ç™»å½•/éªŒè¯è¶…æ—¶é”™è¯¯
    if not result.success and _is_login_timeout_error(result.error):
        logger.warning(f"æ£€æµ‹åˆ°ç™»å½•è¶…æ—¶é”™è¯¯ï¼Œå¯åŠ¨å†·å´æœºåˆ¶")
        _login_timeout_timestamp = time.time()
        return [TextContent(
            type="text", 
            text=f"â¸ï¸ æœç´¢éœ€è¦ç”¨æˆ·éªŒè¯ä½†è¶…æ—¶\n\n"
                 f"é”™è¯¯: {result.error}\n\n"
                 f"è¯¥å·¥å…·å°†æš‚åœ {_LOGIN_COOLDOWN_SECONDS // 60} åˆ†é’Ÿï¼Œé¿å…é‡å¤æ‰“æ‰°ä¸åœ¨åœºçš„ç”¨æˆ·ã€‚\n"
                 f"**æ³¨æ„**: ç”±äº MCP åè®®é™åˆ¶ï¼ŒæœåŠ¡å™¨æ— æ³•æ£€æµ‹å¯¹è¯è¾¹ç•Œã€‚\n"
                 f"å¦‚æœç”¨æˆ·å¼€å§‹æ–°å¯¹è¯ï¼Œå¯ä»¥å»ºè®®ç”¨æˆ·ç­‰å¾…å†·å´æœŸç»“æŸæˆ–ä½¿ç”¨å…¶ä»–æœç´¢å·¥å…·ã€‚"
        )]
    
    if not result.success:
        logger.error(f"æœç´¢å¤±è´¥: {result.error}")
        return [TextContent(type="text", text=f"æœç´¢å¤±è´¥: {result.error}")]
    
    # æ ¼å¼åŒ–è¾“å‡º
    output = format_search_result(result, is_follow_up=follow_up)
    logger.info(f"æœç´¢æˆåŠŸï¼Œè¿”å›ç»“æœé•¿åº¦: {len(output)}")
    
    return [TextContent(type="text", text=output)]


def _is_login_timeout_error(error: str) -> bool:
    """åˆ¤æ–­æ˜¯å¦ä¸ºç™»å½•/éªŒè¯è¶…æ—¶é”™è¯¯
    
    Args:
        error: é”™è¯¯ä¿¡æ¯
        
    Returns:
        æ˜¯å¦ä¸ºç™»å½•è¶…æ—¶ç›¸å…³é”™è¯¯
    """
    timeout_keywords = [
        "éªŒè¯è¶…æ—¶",
        "ç™»å½•è¶…æ—¶",
        "timeout",
        "5åˆ†é’Ÿ",
        "captcha",
        "éªŒè¯ç ",
    ]
    error_lower = error.lower()
    return any(keyword.lower() in error_lower for keyword in timeout_keywords)


def format_search_result(result: SearchResult, is_follow_up: bool = False) -> str:
    """æ ¼å¼åŒ–æœç´¢ç»“æœä¸º Markdown
    
    Args:
        result: SearchResult å¯¹è±¡
        is_follow_up: æ˜¯å¦ä¸ºè¿½é—®ç»“æœ
        
    Returns:
        Markdown æ ¼å¼çš„å­—ç¬¦ä¸²
    """
    if is_follow_up:
        output = f"## AI è¿½é—®ç»“æœ\n\n"
    else:
        output = f"## AI æœç´¢ç»“æœ\n\n"
    
    output += f"**æŸ¥è¯¢**: {result.query}\n\n"
    output += f"### AI å›ç­”\n\n{result.ai_answer}\n\n"
    
    if result.sources:
        output += f"### æ¥æº ({len(result.sources)} ä¸ª)\n\n"
        for i, source in enumerate(result.sources[:5], 1):
            output += f"{i}. [{source.title}]({source.url})\n"
    
    # æ·»åŠ è¿½é—®æç¤º
    if not is_follow_up:
        output += f"\n---\nğŸ’¡ **æç¤º**: å¦‚éœ€æ·±å…¥äº†è§£ï¼Œå¯ä»¥è®¾ç½® `follow_up: true` è¿›è¡Œè¿½é—®ï¼ŒAI ä¼šåœ¨å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ä¸­ç»§ç»­å›ç­”ã€‚\n"
    
    return output


async def main():
    """ä¸»å…¥å£"""
    async with stdio_server() as (read_stream, write_stream):
        await server.run(
            read_stream, 
            write_stream,
            server.create_initialization_options()
        )


def run():
    """åŒæ­¥å…¥å£ç‚¹ï¼Œä¾›å‘½ä»¤è¡Œä½¿ç”¨"""
    asyncio.run(main())


if __name__ == "__main__":
    run()
